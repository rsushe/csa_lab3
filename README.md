# Лабораторная работа №3

- Сущенко Роман Витальевич, P33131
- forth | stack | neum | hw | instr | binary | trap | port | pstr | prob2 | spi
- базовый вариант

## Язык программирования

```text

<процедура> →   ": " <название процедуры> <программа> " ;"

<программа> →   <пусто> | <слово> | <программа> " " <программа> | <условный оператор> |
                <оператор цикла do loop> | <оператор цикла begin until> <объявление переменной>
                
<объявление переменной> → "variable " <переменная> ["allot " <целочисленный литерал>] 

<условный оператор> → if <программа> [else <программаа>] then  

<оператор цикла do loop> → do <программа> loop  

<оператор цикла begin until> → begin <программа> until  

<слово> →   <целочисленный литерал> | <математический оператор> | <отображение строки> | <название процедуры> |
            "mod" | "drop" | "swap" | "over" | "dup" | "read" | "omit" | <переменная> | "@" | "!" | "ei" | "di"

<математический оператор> → "+" | "-" | "*" | "/" | "=" | "<" | ">" 

<отображение строки> → "." <строковый литерал>

```

Код выполняется последовательно за исключением процедур.
Вызов процедуры осуществляется при указании в программе её названия.

Ниже описаны основные стековые операции в виде (stack_before -- stack_after) с некоторыми пояснениями.

- ```+``` - (n1 n2 -- n3)
- ```-``` - (n1 n2 -- n3)
- ```*``` - (n1 n2 -- n3)
- ```/``` - (n1 n2 -- n3)
- ```=``` - (n1 n2 -- n3) - n3 = 1 если n1 == n2, иначе n3 = 0
- ```>``` - (n1 n2 -- n3) n3 = 1 если n1 > n2, иначе n3 = 0
- ```<``` - (n1 n2 -- n3) n3 = 1 если n1 < n2, иначе n3 = 0
- ```mod``` - (n1 n2 -- n3) - n1 % n2
- ```drop``` - (n1 -- )
- ```swap``` - (n1 n2 -- n2 n1)
- ```over``` - (n1 n2 -- n1 n2 n1)
- ```dup``` - (n1 -- n1 n1) -
- ```key``` - (n1 -- n2) - ввод c порта n1
- ```omit``` - (n1 n2 -- ) - вывести ASCII символ с кодом n1 в IO порт n2
- ```read``` - (n1 -- n2) - прочитать значение с порта n1 и положить на стек
- ```!``` - (n1 n2 -- ) - записать значение n1 в ячейку памяти n2
- ```@``` - (n1 -- n2) - прочитать значение из ячейки памяти n1 и положить его на стек

Условный оператор ```if``` выполняется в зависимости от истинности значения на вершине стека.
Истинным значением является любое целое числа за исключением 0. Соответственно ложным значением является 0.

Оператор цикла ```do loop``` выполняет ```K``` итераций в зависимости от двух значений на вершине стека (n1 n2);
```K = n1 - n2```. Внутри конструкции ```do loop``` возможно использовать
переменную ```i```, ```i = n2 + <номер итерации>```.
Аналогично конструкции ```for (i = n2; i < n1; i++) {}```

Оператор цикла ```begin until``` выполняет итерации до момента, когда на вершине стека
по достижению конструкции ```until``` не будет лежать истинное значение (отличное от нуля).

Оператор объявления переменной ```variable``` создаёт переменную и сопоставляет ей
определенную ячейку памяти, взаимодействовать с которой возможно при помощи ```!``` и ```@```.
В случае добавления ключевого слова ```allot``` выделяется непрерывный участок памяти с фиксированным
в программе размером.

Комментарии не предусмотрены.

Используемые литералы:

- строковые литералы - имеют вид " <строка>", используются для экранизации текста после оператора ```.```
- целочисленные литералы - являются полноценным словом в программе и необходимы для того, чтобы положить конкретное
  значение на вершину стека, диапазон значений - $[-2^{31}, 2^{31} - 1]$

## Организация памяти

- Память данных и команд общая
- Размер машинного слова - 24 бита
- Для команды: первые 8 бит - тип команды
- Программисту в явном виде доступен исключительно стек данных и память, зарезервированная под переменные
- Память выделяется статически при запуске модели
- Доступен один вид прерываний - его обработчик лежит по адресу 01 в памяти команд
- Процедуры хранятся в памяти последовательно, и вызов может быть выполнен из любой
  части программы. Подробнее - см. трансляция.
- Машинная команда может использоваться как с аргументами (адрес/значение), так и без них.
- Ввиду специфики варианта, числовые и строковые литералы записываются в память данных в
  момент исполнения программы, а не при запуске модели с помощью команд с Immediate Value.
  Формирование команд для записи строковых литералов -- на этапе трансляции
- Все переменные хранятся статически в памяти данных
- Используется стек данных и стек возврата, они являются отдельным физическим устройством
  по отношению к памяти данных и команд (см. модель процессора)

Память

```text

+-----------------------------+
| 00       jmp N              |
| 01       interrupt handle   |
|      ...                    |
| N - 1    interrupt handle   |
+-----------------------------+
| N        program            |
| N + 1    program            |
|      ...                    |
| 15000    program            |
+-----------------------------+
| 15001    string literals    |  |
| 15002    string literals    |  |
|      ...                    |  v
| 15511    strings literal    |  
+-----------------------------+
| 15512    variables          |  |
| 15513    variables          |  |
|      ...                    |  v
| 30000    variables          |  
+-----------------------------+
```

Вид команды:

```text
+--------------------------------------------------------------------------------------+
| Код команды (0:7) | Адрес / Immediate Value (8:23)    |
+--------------------------------------------------------------------------------------+
```

## Система команд

### Цикл исполнения команды

1. Выборка инструкции (без сохранения информации в промежуточные регистры)
2. Исполнение команды (количество тактов необходимых для исполнения указано в таблице ниже)
3. Проверка на прерывание (если прерывание, сохранение PC в Return Stack, переход к обработчику прерывания)

### Набор инструкций

Большинство инструкций языка в явном виде соответствуют машинным командам, в таблице ниже
приведены все элементы системы команд ([isa.py](src/isa.py)). Те машинные команды, которые без комментария --
соответствуют слову из языка программирования. Спецификация количества тактов и последовательность
действий -- в разделе "Модель процессора".

| Инструкция        | Комментарий                                                            |
|:------------------|:-----------------------------------------------------------------------|
| mul               |                                                                        |
| div               |                                                                        |
| sub               |                                                                        |
| add               |                                                                        |
| mod               |                                                                        |
| eq                |                                                                        |
| gr                |                                                                        |
| ls                |                                                                        |
| drop              |                                                                        |
| swap              |                                                                        |
| over              |                                                                        |
| dup               |                                                                        |
| ei                | разрешить прерывания                                                   |
| di                | запретить прерывания                                                   |
| omit              |                                                                        |
| read              |                                                                        |
| store             | память данных из стека                                                 |
| load              | в стек из памяти данных                                                |
| push imm          | записать в стек непосредственное значение                              |
| pop               | перенести значение со стека данных в стек возврата                     |
| rpop              | перенести значение из стека возврата в стек данных                     |
| jmp ```<addr>```  | перейти по адресу                                                      |
| zjmp ```<addr>``` | перейти по адресу, если на вершине стека 0 (убирает значение со стека) |
| call ```<addr>``` | вызов процедуры                                                        |
| ret               | выход из процедуры или прерывания                                      |
| halt              | завершение программы                                                   |

```<addr>``` - прямая адресация

### Кодирование инструкций

Инструкции кодируются в бинарный формат
